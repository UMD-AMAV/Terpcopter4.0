function [yawStickCmd, pitchStickCmd, rollStickCmd,velPitchControl,pitchControl, rollControl] = VelocityPID(velPitchControl,pitchControl, rollControl, curTime, yawDeg, vx_d, vx, vy_d, vy)

% gains/parameters
Kp_pitch = 0.10;
Kp_roll = 0.10;
Ki_pitch = 0;%0.001
Ki_roll = 0;%0.001
Kd_pitch = 0;
Kd_roll = 0;
% pitchStickLimit = 0.25;
% rollStickLimit = 0.25;

% unpack states
vy_prev = velpitchControl.vy_errorprev;
vy_errorsum = velpitchControl.vy_errorsum;
prevRollCmd = rollControl.prevVal;

% calculate attitude error in inertial frame
vx_error = vx_d - vx
vy_error = vy_d - vy

vy_errorsum = vy_errorsum + vy_error

% % Rotation from inertial frame to quad body frame
% vx_error = vx_error*cosd(relativeYawDeg) + vy_error*sind(relativeYawDeg)
% vy_error = -vx_error*sind(relativeYawDeg) + vy_error*cosd(relativeYawDeg)



% proportional control scaled to unit vector
pitchStickCmd = Kp_pitch*vy_error + Ki_pitch*vy_errorsum + Kd_pitch*vy_prev;
rollStickCmd = -(Kp_roll*vx_error + Ki_roll*vy_errorsum + Kd_pitch*vy_prev);


% pack up structure
velPitchControl.lastTime = curTime;
velPitchControl.prevVal = yawDeg;

end

function [pitchStickCmd, pitchControl] = velpitchController(pitchControl, curTime, pitchDeg, pitchDesDeg)

% gains/parameters
pitchFiltTimeConstant = 0.2; % seconds
kp = 0.15/5; % estimate : 10 deg error gives 0.1 stick cmd with kp = 0.1/10;
pitchStickLimit = 0.2;

% unpack states
prevPitchDeg = pitchControl.prevVal;
lastTime = pitchControl.lastTime;

% time elapsed since last control
dt = curTime - lastTime;

% low-pass filter
alpha = dt / ( pitchFiltTimeConstant + dt);
pitchFiltDeg = (1-alpha)*prevPitchDeg + alpha*pitchDeg;

% altitude error
pitchErrorDeg = pitchDesDeg - pitchFiltDeg;

% proportional control
pitchStickCmd = kp*pitchErrorDeg; 

% saturate
pitchStickCmd = max(-pitchStickLimit,min(pitchStickCmd,pitchStickLimit));

%% pack up structure
pitchControl.lastTime = curTime;
pitchControl.prevVal = prevPitchDeg;

% display/debug
displayFlag = 1;
if ( displayFlag )
    
    pFile = fopen( pitchControl.log ,'a');
    
    % write csv file
    fprintf(pFile,'%6.6f,',curTime);
    fprintf(pFile,'%6.6f,',dt);
    fprintf(pFile,'%6.6f,',pitchDesDeg);
    fprintf(pFile,'%6.6f,',pitchDeg);
    fprintf(pFile,'%6.6f,',pitchFiltDeg);
    fprintf(pFile,'%6.6f,',pitchErrorDeg);
    fprintf(pFile,'%6.6f,',pitchStickCmd);
       
    % constant parameters
    fprintf(pFile,'%6.6f,',pitchFiltTimeConstant);
    fprintf(pFile,'%6.6f,',kp);
    fprintf(pFile,'%6.6f\n,',pitchStickLimit);


    fclose(pFile);
    
end
end